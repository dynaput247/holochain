FROM nixorg/nix:circleci
ENV NIX_PATH nixpkgs=https://github.com/NixOS/nixpkgs/archive/47f008676fe3b77b9c8edda54db621a0dc16dd8e.tar.gz

WORKDIR ~

# warm nix
# this is slow so we don't want to redo it if possible so we run a no-op

COPY shell.nix shell.nix

# pop the test suite off once to warm the incremental rust cache
RUN nix-shell --run hc-test --show-trace --max-jobs 4 --cores 0
